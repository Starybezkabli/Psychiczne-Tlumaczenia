import React, { useEffect, useMemo, useState } from "react";
import { motion } from "framer-motion";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

// ================= CONFIG =================
const TAGS = [
  "yaoi","yuri","hetero","romans","akcja","kryminalne","horror","krwawe","wampiry","inny świat","fantasy","wilkołaki","dziewczyny","chłopcy","przyjaciele z dzieciństwa","rodzina królewska","psychologiczne","kosmici","szkolne","policja","historyczne","slice of life","omegaverse","wojna","walki","morderstwa","lochy","potwory","magiczne","auta","wyścigi","drama","różnica wieku","demony","anioły","zagadki","ninja","zmiana ciał","komedia","duchy","dzieci","dla dorosłych","medyczne","sm/bdsm/sub-dom","gry wideo","muzyka","konkurencje","wróżki","fetysze","zemsta","klątwy"
];

const TYPES = ["manhwa","manga","manhua","novelka","webtoon","one shot"];
const STATUS = ["aktywne","zakończone"];

const load = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

// ================= APP =================
export default function App() {
  const [series, setSeries] = useState(() => load("pt_series", []));
  const [news, setNews] = useState(() => load("pt_news", []));
  const [team, setTeam] = useState(() => load("pt_team", []));

  const [view, setView] = useState({ page: "home" });
  const [query, setQuery] = useState("");
  const [menuOpen, setMenuOpen] = useState(false);

  useEffect(() => save("pt_series", series), [series]);
  useEffect(() => save("pt_news", news), [news]);
  useEffect(() => save("pt_team", team), [team]);

  const filtered = useMemo(() => {
    const q = query.toLowerCase();
    return series.filter(s =>
      s.title.toLowerCase().includes(q) ||
      s.tags.some(t => t.toLowerCase().includes(q))
    );
  }, [series, query]);

  const openSeries = s => setView({ page: "series", id: s.id });
  const currentSeries = series.find(s => s.id === view.id);

  return (
    <div className="min-h-screen bg-gradient-to-b from-purple-950 via-black to-purple-950 text-purple-100">

      {/* ===== HEADER (Batoto‑like) ===== */}
      <div className="sticky top-0 z-50 bg-purple-900 border-b border-purple-700">
        <div className="flex items-center justify-between p-4">
          <div
            className="text-2xl font-bold cursor-pointer"
            onClick={() => setView({ page: "home" })}
          >
            Psychiczne tłumaczenia
          </div>

          <Button onClick={() => setMenuOpen(!menuOpen)}>☰</Button>
        </div>

        {/* search + filters */}
        <div className="p-3 flex flex-col gap-2 bg-purple-950 border-t border-purple-800">
          <Input
            placeholder="Szukaj tytułu lub tagów…"
            value={query}
            onChange={e => setQuery(e.target.value)}
            className="bg-black/40"
          />

          <div className="flex flex-wrap gap-2 text-xs">
            {TYPES.map(t => (
              <span key={t} className="px-2 py-1 bg-purple-800 rounded">{t}</span>
            ))}
            {STATUS.map(s => (
              <span key={s} className="px-2 py-1 bg-purple-700 rounded">{s}</span>
            ))}
          </div>
        </div>

        {/* dropdown library */}
        {menuOpen && (
          <div className="max-h-72 overflow-auto bg-black border-t border-purple-800">
            {filtered.map(s => (
              <div
                key={s.id}
                className="p-3 hover:bg-purple-800 cursor-pointer border-b border-purple-900"
                onClick={() => {
                  openSeries(s);
                  setMenuOpen(false);
                }}
              >
                <div className="font-semibold">{s.title}</div>
                <div className="text-xs opacity-70">{s.tags.join(", ")}</div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* nav */}
      <div className="flex gap-2 p-3 flex-wrap">
        <Button onClick={() => setView({ page: "home" })}>Strona główna</Button>
        <Button onClick={() => setView({ page: "library" })}>Biblioteka</Button>
        <Button onClick={() => setView({ page: "admin" })}>Panel</Button>
      </div>

      {/* pages */}
      {view.page === "home" && (
        <Home news={news} team={team} series={series} openSeries={openSeries} />
      )}

      {view.page === "library" && (
        <Library series={filtered} openSeries={openSeries} />
      )}

      {view.page === "series" && currentSeries && (
        <SeriesPage
          data={currentSeries}
          update={updated =>
            setSeries(series.map(s => (s.id === updated.id ? updated : s)))
          }
        />
      )}

      {view.page === "admin" && (
        <AdminPanel
          addSeries={s => setSeries([...series, s])}
          addNews={n => setNews([n, ...news])}
          addTeam={m => setTeam([...team, m])}
        />
      )}
    </div>
  );
}

// ================= HOME =================
function Home({ news, team, series, openSeries }) {
  return (
    <div className="grid lg:grid-cols-3 gap-4 p-4">
      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-2">Nowości</h2>
          {news.map((n, i) => (
            <div key={i} className="mb-3">
              <b>{n.title}</b>
              <p>{n.text}</p>
            </div>
          ))}
        </CardContent>
      </Card>

      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-2">Ostatnio dodane</h2>
          {series.slice(-5).map(s => (
            <div
              key={s.id}
              className="cursor-pointer hover:text-purple-300"
              onClick={() => openSeries(s)}
            >
              {s.title}
            </div>
          ))}
        </CardContent>
      </Card>

      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-2">Zespół</h2>
          {team.map((m, i) => (
            <div key={i} className="mb-2">
              <b>{m.name}</b>
              <p>{m.desc}</p>
            </div>
          ))}
        </CardContent>
      </Card>
    </div>
  );
}

// ================= LIBRARY =================
function Library({ series, openSeries }) {
  return (
    <div className="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-4">
      {series.map(s => (
        <motion.div key={s.id} whileHover={{ scale: 1.03 }}>
          <Card
            className="cursor-pointer hover:bg-purple-900"
            onClick={() => openSeries(s)}
          >
            <CardContent>
              <div className="font-bold">{s.title}</div>
              <div className="text-xs opacity-70">{s.type} • {s.status}</div>
              <div className="text-xs mt-2">{s.tags.slice(0,3).join(", ")}</div>
            </CardContent>
          </Card>
        </motion.div>
      ))}
    </div>
  );
}

// ================= SERIES PAGE =================
function SeriesPage({ data, update }) {
  const [chapterTitle, setChapterTitle] = useState("");
  const [chapterContent, setChapterContent] = useState("");
  const [commentText, setCommentText] = useState("");

  const addChapter = () => {
    if (!chapterTitle) return;

    update({
      ...data,
      chapters: [
        ...data.chapters,
        {
          id: crypto.randomUUID(),
          title: chapterTitle,
          content: chapterContent,
          comments: []
        }
      ]
    });

    setChapterTitle("");
    setChapterContent("");
  };

  const addComment = (chapterId) => {
    if (!commentText) return;

    update({
      ...data,
      chapters: data.chapters.map(c =>
        c.id === chapterId
          ? { ...c, comments: [...c.comments, { text: commentText }] }
          : c
      )
    });

    setCommentText("");
  };

  return (
    <div className="p-4 space-y-4">

      {/* info */}
      <Card>
        <CardContent>
          <h1 className="text-2xl font-bold">{data.title}</h1>
          <p>{data.description}</p>
          <div className="text-xs mt-2">{data.tags.join(", ")}</div>
        </CardContent>
      </Card>

      {/* add chapter */}
      <Card>
        <CardContent className="space-y-2">
          <h3 className="font-bold">Dodaj rozdział</h3>
          <Input placeholder="Tytuł rozdziału" value={chapterTitle} onChange={e=>setChapterTitle(e.target.value)} />
          <Textarea placeholder="Treść / opis / linki do obrazów" value={chapterContent} onChange={e=>setChapterContent(e.target.value)} />
          <Button onClick={addChapter}>Dodaj rozdział</Button>
        </CardContent>
      </Card>

      {/* chapters */}
      {data.chapters.map(ch => (
        <Card key={ch.id}>
          <CardContent>
            <h3 className="font-bold">{ch.title}</h3>
            <div className="whitespace-pre-wrap my-2">{ch.content}</div>

            <h4 className="font-bold mt-2">Komentarze</h4>
            {ch.comments.map((cm, i) => (
              <div key={i} className="text-sm">• {cm.text}</div>
            ))}

            <div className="flex gap-2 mt-2">
              <Input
                placeholder="Dodaj komentarz…"
                value={commentText}
                onChange={e=>setCommentText(e.target.value)}
              />
              <Button onClick={()=>addComment(ch.id)}>Dodaj</Button>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

// ================= ADMIN =================
function AdminPanel({ addSeries, addNews, addTeam }) {
  const [title, setTitle] = useState("");
  const [desc, setDesc] = useState("");
  const [tags, setTags] = useState([]);
  const [type, setType] = useState(TYPES[0]);
  const [status, setStatus] = useState(STATUS[0]);

  const [newsTitle, setNewsTitle] = useState("");
  const [newsText, setNewsText] = useState("");

  const [teamName, setTeamName] = useState("");
  const [teamDesc, setTeamDesc] = useState("");

  const createSeries = () => {
    if (!title) return;

    addSeries({
      id: crypto.randomUUID(),
      title,
      description: desc,
      tags,
      type,
      status,
      chapters: []
    });

    setTitle("");
    setDesc("");
    setTags([]);
  };

  return (
    <div className="p-4 space-y-6">

      {/* series */}
      <Card>
        <CardContent className="space-y-2">
          <h2 className="font-bold">Dodaj serię</h2>

          <Input placeholder="Tytuł" value={title} onChange={e=>setTitle(e.target.value)} />
          <Textarea placeholder="Opis" value={desc} onChange={e=>setDesc(e.target.value)} />

          <Select onValueChange={setType}>
            <SelectTrigger><SelectValue placeholder="Typ" /></SelectTrigger>
            <SelectContent>
              {TYPES.map(t => <SelectItem key={t} value={t}>{t}</SelectItem>)}
            </SelectContent>
          </Select>

          <Select onValueChange={setStatus}>
            <SelectTrigger><SelectValue placeholder="Status" /></SelectTrigger>
            <SelectContent>
              {STATUS.map(s => <SelectItem key={s} value={s}>{s}</SelectItem>)}
            </SelectContent>
          </Select>

          <div className="flex flex-wrap gap-2">
            {TAGS.map(t => (
              <Button
                key={t}
                variant={tags.includes(t) ? "default" : "outline"}
                onClick={() =>
                  setTags(tags.includes(t)
                    ? tags.filter(x => x !== t)
                    : [...tags, t])
                }
              >
                {t}
              </Button>
            ))}
          </div>

          <Button onClick={createSeries}>Zapisz serię</Button>
        </CardContent>
      </Card>

      {/* news */}
      <Card>
        <CardContent className="space-y-2">
          <h2 className="font-bold">Dodaj news</h2>
          <Input placeholder="Tytuł" value={newsTitle} onChange={e=>setNewsTitle(e.target.value)} />
          <Textarea placeholder="Treść" value={newsText} onChange={e=>setNewsText(e.target.value)} />
          <Button onClick={()=>{
            addNews({title:newsTitle,text:newsText});
            setNewsTitle("");
            setNewsText("");
          }}>Dodaj news</Button>
        </CardContent>
      </Card>

      {/* team */}
      <Card>
        <CardContent className="space-y-2">
          <h2 className="font-bold">Dodaj członka zespołu</h2>
          <Input placeholder="Imię" value={teamName} onChange={e=>setTeamName(e.target.value)} />
          <Textarea placeholder="Opis" value={teamDesc} onChange={e=>setTeamDesc(e.target.value)} />
          <Button onClick={()=>{
            addTeam({name:teamName,desc:teamDesc});
            setTeamName("");
            setTeamDesc("");
          }}>Dodaj</Button>
        </CardContent>
      </Card>

    </div>
  );
}
