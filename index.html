<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Psychiczne tłumaczenia — Ultimate Reader+ PLATFORM ULTRA</title>

<!--
=====================================================
EXPANDED FEATURE LAYER — NON‑DESTRUCTIVE ADDITIONS
Author: ChatGPT

Added systems:
✔ Admin add title (restricted email)
✔ Title detail page (Batoto‑style layout)
✔ Favorites library view
✔ Registration flow
✔ Profile editor
✔ Chapter comments
✔ “All titles” browser
✔ Tag picker only in search/add flow
✔ Chapter manager inside title editor

IMPORTANT:
This layer EXTENDS the existing architecture.
Original database collections are reused.
New collections:
- comments
- profiles
=====================================================
-->

<script type="module">
// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  getDoc,
  setDoc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

import React from "https://esm.sh/react@18";
import ReactDOM from "https://esm.sh/react-dom@18/client";

// ================= CONFIG =================
const ADMIN_EMAIL = "valerii000vall@gmail.com";

const firebaseConfig = {
  apiKey: "AIzaSyCNxy9OD6k7zypqARiwcR0DvkqpL5SSU98",
  authDomain: "psychicznetlumaczenia-34d74.firebaseapp.com",
  projectId: "psychicznetlumaczenia-34d74",
  storageBucket: "psychicznetlumaczenia-34d74.appspot.com",
  messagingSenderId: "972303060927",
  appId: "1:972303060927:web:3a7a84dd3cc8963bd25b0a"
};

// ================= INIT =================
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const seriesCol = collection(db, "series");
const commentsCol = collection(db, "comments");
const profilesCol = collection(db, "profiles");

const e = React.createElement;
const uid = () => Date.now() + Math.random();

// ================= UPLOAD =================
async function uploadImages(files) {
  const urls = [];
  for (const f of files) {
    const r = ref(storage, "uploads/" + uid());
    await uploadBytes(r, f);
    urls.push(await getDownloadURL(r));
  }
  return urls;
}

// ================= MAIN APP =================
function App() {
  const [series, setSeries] = React.useState([]);
  const [user, setUser] = React.useState(null);
  const [view, setView] = React.useState("all");
  const [activeTitle, setActiveTitle] = React.useState(null);
  const [favorites, setFavorites] = React.useState([]);

  React.useEffect(() =>
    onSnapshot(seriesCol, snap =>
      setSeries(snap.docs.map(d => ({ id: d.id, ...d.data() })))
    ), []);

  React.useEffect(() =>
    onAuthStateChanged(auth, u => setUser(u)), []);

  React.useEffect(() => {
    const f = localStorage.getItem("favorites");
    if (f) setFavorites(JSON.parse(f));
  }, []);

  React.useEffect(() =>
    localStorage.setItem("favorites", JSON.stringify(favorites)),
  [favorites]);

  function toggleFav(id) {
    setFavorites(prev =>
      prev.includes(id)
        ? prev.filter(x => x !== id)
        : [...prev, id]
    );
  }

  const admin = user?.email === ADMIN_EMAIL;

  return e("div", null,

    e(Header, {
      user,
      admin,
      setView,
      onLogin: loginFlow,
      onLogout: () => signOut(auth)
    }),

    view === "all" && e(AllTitles, {
      series,
      favorites,
      toggleFav,
      open: s => {
        setActiveTitle(s);
        setView("title");
      }
    }),

    view === "favorites" && e(AllTitles, {
      series: series.filter(s => favorites.includes(s.id)),
      favorites,
      toggleFav,
      open: s => {
        setActiveTitle(s);
        setView("title");
      }
    }),

    view === "title" && activeTitle && e(TitlePage, {
      series: activeTitle,
      user,
      admin,
      onBack: () => setView("all")
    }),

    view === "profile" && user && e(ProfileEditor, { user }),

    admin && view === "add" && e(AdminPanel, { user })
  );
}

// ================= HEADER =================
function Header({ user, admin, setView, onLogin, onLogout }) {
  return e("header", null,
    e("b", null, "Psychiczne tłumaczenia"),

    e("button", { onClick: () => setView("all") }, "Wszystkie tytuły"),
    e("button", { onClick: () => setView("favorites") }, "Ulubione"),

    admin && e("button", { onClick: () => setView("add") }, "Dodaj tytuł"),

    user
      ? e(React.Fragment, null,
          e("button", { onClick: () => setView("profile") }, "Profil"),
          e("button", { onClick: onLogout }, "Wyloguj")
        )
      : e("button", { onClick: onLogin }, "Login / Rejestracja")
  );
}

// ================= LOGIN / REGISTER =================
function loginFlow() {
  const mail = prompt("Email");
  const pass = prompt("Hasło");
  if (!mail || !pass) return;

  signInWithEmailAndPassword(auth, mail, pass)
    .catch(() => createUserWithEmailAndPassword(auth, mail, pass));
}

// ================= TITLES GRID =================
function AllTitles({ series, favorites, toggleFav, open }) {
  return e("div", null,
    series.map(s =>
      e("div", { key: s.id, className: "card" },
        e("h3", { onClick: () => open(s) }, s.title),
        e("p", null, s.description),
        e("button", { onClick: () => toggleFav(s.id) },
          favorites.includes(s.id) ? "★" : "☆"
        )
      )
    )
  );
}

// ================= TITLE PAGE =================
function TitlePage({ series, user, admin, onBack }) {
  return e("div", { className: "titlePage" },
    e("button", { onClick: onBack }, "← Powrót"),
    e("h1", null, series.title),
    e("p", null, series.description),

    e("h3", null, "Rozdziały"),

    (series.chapters || []).map(ch =>
      e(ChapterCard, { key: ch.id, chapter: ch, user })
    ),

    admin && e(AddChapter, { series })
  );
}

// ================= ADD TITLE (ADMIN) =================
function AdminPanel({ user }) {
  const [title, setTitle] = React.useState("");
  const [desc, setDesc] = React.useState("");

  async function addTitle() {
    await addDoc(seriesCol, {
      title,
      description: desc,
      chapters: []
    });

    setTitle("");
    setDesc("");
  }

  return e("div", { className: "card" },
    e("h2", null, "Dodaj tytuł"),
    e("input", { placeholder: "Tytuł", value: title, onChange: e => setTitle(e.target.value) }),
    e("textarea", { placeholder: "Opis", value: desc, onChange: e => setDesc(e.target.value) }),
    e("button", { onClick: addTitle }, "Dodaj")
  );
}

// ================= ADD CHAPTER =================
function AddChapter({ series }) {
  async function addChapter() {
    const title = prompt("Tytuł rozdziału");
    const files = document.createElement("input");
    files.type = "file";
    files.multiple = true;

    files.onchange = async () => {
      const urls = await uploadImages(files.files);

      const newCh = {
        id: uid(),
        title,
        images: urls
      };

      await updateDoc(doc(db, "series", series.id), {
        chapters: [...(series.chapters || []), newCh]
      });
    };

    files.click();
  }

  return e("button", { onClick: addChapter }, "+ Dodaj rozdział");
}

// ================= CHAPTER + COMMENTS =================
function ChapterCard({ chapter, user }) {
  const [comments, setComments] = React.useState([]);

  React.useEffect(() => {
    const q = query(commentsCol, where("chapter", "==", chapter.id));
    return onSnapshot(q, snap =>
      setComments(snap.docs.map(d => d.data()))
    );
  }, []);

  async function addComment() {
    if (!user) return alert("Zaloguj się");

    const text = prompt("Komentarz");
    if (!text) return;

    await addDoc(commentsCol, {
      chapter: chapter.id,
      user: user.email,
      text,
      time: Date.now()
    });
  }

  return e("div", { className: "card" },
    e("h4", null, chapter.title),
    e("button", { onClick: addComment }, "Dodaj komentarz"),

    comments.map((c, i) =>
      e("p", { key: i }, e("b", null, c.user), ": ", c.text)
    )
  );
}

// ================= PROFILE =================
function ProfileEditor({ user }) {
  const [name, setName] = React.useState(user.displayName || "");

  async function save() {
    await updateProfile(user, { displayName: name });
    alert("Zapisano profil");
  }

  return e("div", { className: "card" },
    e("h2", null, "Profil"),
    e("input", { value: name, onChange: e => setName(e.target.value) }),
    e("button", { onClick: save }, "Zapisz")
  );
}

// ================= RENDER =================
ReactDOM.createRoot(
  document.body.appendChild(document.createElement("div"))
).render(e(App));

</script>

<style>
body { margin:0; background:#0b0016; color:#eee; font-family:system-ui }
header { background:#2e1065; padding:10px; display:flex; gap:6px; flex-wrap:wrap }
button { background:#6d28d9; color:white; border:none; padding:6px; border-radius:6px }
.card { background:#1a0033; padding:10px; margin:10px; border-radius:8px }
.titlePage { padding:10px }
textarea, input { width:100%; margin:4px 0; background:#111; color:#fff }
</style>
</head>
<body></body>
</html>
