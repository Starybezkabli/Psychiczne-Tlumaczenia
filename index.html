<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Psychiczne tłumaczenia — Ultimate Reader+ PLATFORM ULTRA</title>

<script type="module">
// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

import React from "https://esm.sh/react@18";
import ReactDOM from "https://esm.sh/react-dom@18/client";

// Firebase config (twoje dane)
const firebaseConfig = {
  apiKey: "AIzaSyCNxy9OD6k7zypqARiwcR0DvkqpL5SSU98",
  authDomain: "psychicznetlumaczenia-34d74.firebaseapp.com",
  projectId: "psychicznetlumaczenia-34d74",
  storageBucket: "psychicznetlumaczenia-34d74.appspot.com",
  messagingSenderId: "972303060927",
  appId: "1:972303060927:web:3a7a84dd3cc8963bd25b0a",
  measurementId: "G-W04TWH51KD"
};

// ================= INIT =================
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const seriesCol = collection(db, "series");
const usersCol = collection(db, "users");

const TAGS = [
"yaoi","yuri","hetero","romans","akcja","kryminalne","horror","krwawe","wampiry","inny świat","fantasy","wilkołaki","dziewczyny","chłopcy","przyjaciele z dzieciństwa","rodzina królewska","psychologiczne","kosmici","szkolne","policja","historyczne","slice of life","omegaverse","wojna","walki","morderstwa","lochy","potwory","magiczne","auta","wyścigi","drama","różnica wieku","demony","anioły","zagadki","ninja","zmiana ciał","komedia","duchy","dzieci","dla dorosłych","medyczne","sm/bdsm/sub-dom","gry wideo","muzyka","konkurencje","wróżki","fetysze","zemsta","klątwy"
];

const e = React.createElement;
const uid = () => Date.now() + Math.random();

// ================= UPLOAD =================
async function uploadImages(files) {
  const urls = [];
  for (const f of files) {
    const r = ref(storage, "uploads/" + uid());
    await uploadBytes(r, f);
    urls.push(await getDownloadURL(r));
  }
  return urls;
}

// ================= APP =================
function App() {
  const [series, setSeries] = React.useState([]);
  const [user, setUser] = React.useState(null);
  const [favorites, setFavorites] = React.useState([]);
  const [query, setQuery] = React.useState("");
  const [activeTags, setActiveTags] = React.useState([]);
  const [sort, setSort] = React.useState("rating");
  const [reader, setReader] = React.useState(null);

  // realtime sync
  React.useEffect(() =>
    onSnapshot(seriesCol, snap =>
      setSeries(snap.docs.map(d => ({ id: d.id, ...d.data() })))
    ), []);

  // auth
  React.useEffect(() =>
    onAuthStateChanged(auth, u => setUser(u)), []);

  // favorites local
  React.useEffect(() => {
    const f = localStorage.getItem("favorites");
    if (f) setFavorites(JSON.parse(f));
  }, []);

  React.useEffect(() =>
    localStorage.setItem("favorites", JSON.stringify(favorites)),
  [favorites]);

  function toggleFav(id) {
    setFavorites(prev =>
      prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
    );
  }

  function toggleTag(tag) {
    setActiveTags(prev =>
      prev.includes(tag)
        ? prev.filter(t => t !== tag)
        : [...prev, tag]
    );
  }

  // filter + sort
  let filtered = series.filter(s => {
    const q = s.title?.toLowerCase().includes(query.toLowerCase());
    const t = !activeTags.length || activeTags.every(tag => s.tags?.includes(tag));
    return q && t;
  });

  if (sort === "rating") filtered.sort((a,b)=>(b.rating||0)-(a.rating||0));
  if (sort === "title") filtered.sort((a,b)=>a.title.localeCompare(b.title));

  return e("div", null,

    e("header", null,
      e("b", null, "Ultimate Reader+"),
      e("input", {
        placeholder: "Szukaj…",
        value: query,
        onChange: e => setQuery(e.target.value)
      }),
      e("select", { value: sort, onChange:e=>setSort(e.target.value)},
        e("option", {value:"rating"}, "Sortuj: ocena"),
        e("option", {value:"title"}, "Sortuj: tytuł")
      ),
      user
        ? e("button", { onClick: ()=>signOut(auth) }, "Wyloguj")
        : e("button", { onClick: ()=>LoginModal() }, "Login")
    ),

    e("div", { className:"tags" },
      TAGS.map(tag =>
        e("button", {
          key:tag,
          className: activeTags.includes(tag)?"active":"",
          onClick:()=>toggleTag(tag)
        }, tag)
      )
    ),

    filtered.map(s =>
      e("div", { key:s.id, className:"card" },
        e("h3", null, s.title),
        e("p", null, s.description),
        e("div", null, "⭐", s.rating||0),
        e("button", { onClick:()=>toggleFav(s.id) }, favorites.includes(s.id)?"★":"☆"),
        (s.chapters||[]).map(ch =>
          e("button", { key:ch.id, onClick:()=>setReader(ch) }, ch.title)
        )
      )
    ),

    reader && e(Reader, { chapter:reader, user, onClose:()=>setReader(null) })
  );
}

// ================= READER + CLOUD PROGRESS =================
function Reader({ chapter, user, onClose }) {
  const [page, setPage] = React.useState(0);

  React.useEffect(()=>{
    if(!user) return;

    const refDoc = doc(db, "users", user.email);
    getDoc(refDoc).then(d=>{
      const prog = d.data()?.progress?.[chapter.id];
      if(prog!=null) setPage(prog);
    });
  },[]);

  React.useEffect(()=>{
    if(!user) return;

    const refDoc = doc(db, "users", user.email);
    setDoc(refDoc, {
      progress:{ [chapter.id]:page }
    }, { merge:true });
  },[page]);

  return e("div", { className:"reader" },
    e("button", { onClick:onClose }, "Zamknij"),
    e("img", { src:chapter.images?.[page] }),
    e("div", null,
      e("button", { onClick:()=>setPage(p=>Math.max(0,p-1)) }, "←"),
      e("button", { onClick:()=>setPage(p=>Math.min((chapter.images?.length||1)-1,p+1)) }, "→")
    )
  );
}

// ================= LOGIN =================
function LoginModal() {
  const mail = prompt("email");
  const pass = prompt("hasło");
  if(mail && pass) signInWithEmailAndPassword(auth, mail, pass)
    .catch(()=>createUserWithEmailAndPassword(auth, mail, pass));
}

// ================= RENDER =================
ReactDOM.createRoot(document.body.appendChild(document.createElement("div"))).render(e(App));

</script>

<style>
body { margin:0; background:#0b0016; color:#eee; font-family:system-ui }
header { background:#2e1065; padding:10px; display:flex; gap:6px; flex-wrap:wrap }
button { background:#6d28d9; color:white; border:none; padding:6px; border-radius:6px }
.card { background:#1a0033; padding:10px; margin:10px; border-radius:8px }
.reader { position:fixed; inset:0; background:black; padding:10px }
img { max-width:100% }
.tags { padding:6px }
.active { background:#9333ea }
</style>
</head>
<body></body>
</html>
