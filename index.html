<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

const e = React.createElement;

// ------------------- FIREBASE -------------------
const firebaseConfig = {
  apiKey: "AIzaSyCNxy9OD6k7zypqARiwcR0DvkqpL5SSU98",
  authDomain: "psychicznetlumaczenia-34d74.firebaseapp.com",
  projectId: "psychicznetlumaczenia-34d74",
  storageBucket: "psychicznetlumaczenia-34d74.appspot.com",
  messagingSenderId: "972303060927",
  appId: "1:972303060927:web:3a7a84dd3cc8963bd25b0a",
  measurementId: "G-W04TWH51KD"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const seriesCol = collection(db, "series");
const commentsCol = collection(db, "comments");

// ------------------- HELPERS -------------------
const TAGS = ["yaoi","yuri","hetero","romans","akcja","kryminalne","horror","krwawe","wampiry","inny świat","fantasy","wilkołaki","dziewczyny","chłopcy","przyjaciele z dzieciństwa","rodzina królewska","psychologiczne","kosmici","szkolne","policja","historyczne","slice of life","omegaverse","wojna","walki","morderstwa","lochy","potwory","magiczne","auta","wyścigi","drama","różnica wieku","demony","anioły","zagadki","ninja","zmiana ciał","komedia","duchy","dzieci","dla dorosłych","medyczne","sm/bdsm/sub-dom","gry wideo","muzyka","konkurencje","wróżki","fetysze","zemsta","klątwy"];

const uid = () => Date.now() + Math.random();

// Admin testowy
const ADMIN = { name: "Admin", mail: "admin@test.com", pass: "1234" };

// LocalStorage helpers
function save(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
function load(key, def) { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; }

// ------------------- FIRESTORE HELPERS -------------------
async function listenSeries(callback){
  onSnapshot(seriesCol, snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    callback(data);
  });
}

async function addSeriesFirebase(s){
  await addDoc(seriesCol, s);
}

// ------------------- APP -------------------
function App(){
  const [series, setSeries] = React.useState([]);
  const [user, setUser] = React.useState(null);
  const [favorites, setFavorites] = React.useState([]);
  const [view, setView] = React.useState("home");
  const [active, setActive] = React.useState(null);
  const [reader, setReader] = React.useState(null);
  const [query, setQuery] = React.useState("");
  const [selectedTags, setSelectedTags] = React.useState([]);
  const [showSearch, setShowSearch] = React.useState(false);

  const [accounts, setAccounts] = React.useState(load("accounts", {}));
  const [team, setTeam] = React.useState(load("team", []));
  const [comments, setComments] = React.useState(load("comments", []));
  const [history, setHistory] = React.useState(load("history", []));

  React.useEffect(() => {
    listenSeries(setSeries);
    onAuthStateChanged(auth, u => {
      if(u) setUser({ name: u.email, mail: u.email });
      else setUser(null);
    });
  }, []);

  React.useEffect(() => save("accounts", accounts), [accounts]);
  React.useEffect(() => save("team", team), [team]);
  React.useEffect(() => save("comments", comments), [comments]);
  React.useEffect(() => save("history", history), [history]);

  const topSeries = [...series].sort((a,b)=>b.rating-(a.rating||0)).slice(0,5);
  const filtered = series.filter(s=>{
    const q = query.toLowerCase();
    const text = !q || s.title.toLowerCase().includes(q);
    const tags = !selectedTags.length || selectedTags.every(t => s.tags.includes(t));
    return text && tags;
  });

  function toggleFav(id){
    setFavorites(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev,id]);
  }

  function addHistoryEntry(entry){
    setHistory(prev => [...prev, entry]);
  }

  return e("div", null,
    e("header", null,
      e("b",{style:{cursor:"pointer"}, onClick:()=>{setView("home"); setActive(null);}},"Psychiczne tłumaczenia"),
      e("input",{placeholder:"Szukaj…", value:query, onFocus:()=>setShowSearch(true), onChange:e=>setQuery(e.target.value)}),
      e("button",{onClick:()=>setView("library")},"Biblioteka"),
      e("button",{onClick:()=>setView("profile")},"Profil"),
      user ? e("button",{onClick:()=>signOut(auth)},"Wyloguj") : e("button",{onClick:()=>setView("login")},"Login"),
      showSearch && e("div",{className:"searchPanel"},
        e("b",null,"Filtruj tagi:"),
        TAGS.map(t => e("span",{key:t,className:"tag",
          style:{background:selectedTags.includes(t)?"#9333ea":"#3b0764"},
          onClick:()=>setSelectedTags(selectedTags.includes(t)?selectedTags.filter(x=>x!==t):[...selectedTags,t])
        }, t))
      )
    ),
    e("div",{style:{padding:12}},
      view==="home" && e(Home,{series:filtered, topSeries, open:s=>{setActive(s);setView("series");}, favorites, toggleFav, comments, setComments, team, setTeam, user}),
      view==="series" && active && e(SeriesComp,{data:active, setSeries, user, isAdmin:user?.mail===ADMIN.mail, setReader, addHistory:addHistoryEntry, comments, setComments}),
      view==="library" && e(LibraryComp,{series, favorites, open:s=>{setActive(s);setView("series");}}),
      view==="add" && e(AddSeriesComp,{add:addSeriesFirebase}),
      view==="login" && e(LoginComp,{setUser, accounts, setAccounts}),
      view==="profile" && e(ProfileComp,{user, accounts, setAccounts, history})
    ),
    reader && e(ReaderComp,{chapter:reader, onClose:()=>setReader(null)})
  );
}

// ------------------- COMPONENTS -------------------

// Home
function Home({series, topSeries, open, favorites, toggleFav, isAdmin, team, setTeam, comments, setComments, user}){
  const [name, setName] = React.useState("");
  const [img, setImg] = React.useState(null);
  const [comment, setComment] = React.useState("");

  function upload(e){ 
    const r = new FileReader(); 
    r.onload=()=>setImg(r.result); 
    r.readAsDataURL(e.target.files[0]); 
  }

  function addMember(){ 
    if(!name||!img) return; 
    setTeam([...team,{id:uid(), name, avatar:img}]); 
    setName(""); setImg(null); 
  }

  function addGlobalComment(){
    if(!comment.trim()||!user) return;
    setComments([...comments, {id:uid(), user:user.name, text:comment}]);
    setComment("");
  }

  return e("div", null,
    e("div",{className:"card"},
      e("h3",null,"Top 5 popularnych serii"),
      e("div",{className:"grid"},
        topSeries.map(s=>e("div",{key:s.id,className:"card"}, 
          s.cover && e("img",{src:s.cover,className:"cover",onClick:()=>open(s)}),
          e("b",{onClick:()=>open(s)},s.title),
          e(RatingComp,{series:s}),
          e("button",{onClick:()=>toggleFav(s.id)},favorites.includes(s.id)?"★":"☆")
        ))
      )
    ),
    e("div",{className:"card"},
      e("h3",null,"Wszystkie serie"),
      e("div",{className:"grid"},
        series.map(s=>e("div",{key:s.id,className:"card"},
          s.cover && e("img",{src:s.cover,className:"cover",onClick:()=>open(s)}),
          e("b",{onClick:()=>open(s)},s.title),
          e(RatingComp,{series:s}),
          e("button",{onClick:()=>toggleFav(s.id)},favorites.includes(s.id)?"★":"☆")
        ))
      )
    ),
    user?.mail===ADMIN.mail && e("div",{className:"card"},
      e("h3",null,"Dodaj członka zespołu"),
      e("input",{placeholder:"Nick",value:name,onChange:e=>setName(e.target.value)}),
      e("input",{type:"file",accept:"image/*",onChange:upload}),
      e("button",{onClick:addMember},"Dodaj")
    ),
    e("div",{className:"card"},
      e("h3",null,"Globalne komentarze"),
      e("input",{placeholder:"Komentarz…",value:comment,onChange:e=>setComment(e.target.value),onKeyDown:e=>{if(e.key==="Enter") addGlobalComment();}}),
      e("button",{onClick:addGlobalComment},"Dodaj"),
      comments.map(c=>e("div",{key:c.id,className:"comment"},e("b",null,c.user+": "),c.text))
    ),
    e("div",{className:"card"},
      e("h3",null,"Zespół"),
      team.map(m=>e("div",{key:m.id,className:"teamMember"},
        e("img",{src:m.avatar,className:"smallAvatar"}),
        e("span",null,m.name)
      ))
    )
  );
}

// SeriesComp
function SeriesComp({data, setSeries, user, isAdmin, setReader, addHistory, comments, setComments}){
  const [title, setTitle] = React.useState("");
  const [images, setImages] = React.useState([]);
  const [comment, setComment] = React.useState("");

  function upload(e){ 
    const files=[...e.target.files]; 
    Promise.all(files.map(f=>new Promise(r=>{
      const fr=new FileReader();
      fr.onload=()=>r(fr.result);
      fr.readAsDataURL(f);
    }))).then(setImages); 
  }

  function addChapter(){
    if(!isAdmin||!title) return; 
    const ch={id:uid(),title,images,comments:[],rating:0}; 
    const updated={...data,chapters:[...(data.chapters||[]),ch]}; 
    setSeries(prev=>prev.map(s=>s.id===data.id?updated:s)); 
    setTitle(""); setImages([]);
  }

  function deleteChapter(chId){
    const updated={...data,chapters:(data.chapters||[]).filter(c=>c.id!==chId)};
    setSeries(prev=>prev.map(s=>s.id===data.id?updated:s));
  }

  function addCommentToChapter(ch){
    if(!user||!comment) return;
    const updated={...data,chapters:data.chapters.map(c=>c.id===ch.id?{...c,comments:[...c.comments,{user:user.name,text:comment}]}:c)};
    setSeries(prev=>prev.map(s=>s.id===data.id?updated:s));
    setComment("");
  }

  return e("div", null,
    e("div",{className:"card"},
      e("h2",null,data.title),
      data.cover && e("img",{src:data.cover,className:"cover"}),
      e("p",null,data.description),
      isAdmin && e("button",{onClick:()=>setSeries(prev=>prev.filter(s=>s.id!==data.id))},"Usuń serię")
    ),
    isAdmin && e("div",{className:"card"},
      e("h3",null,"Dodaj rozdział"),
      e("input",{placeholder:"Tytuł rozdziału",value:title,onChange:e=>setTitle(e.target.value)}),
      e("input",{type:"file",multiple:true,accept:"image/*",onChange:upload}),
      e("button",{onClick:addChapter},"Dodaj")
    ),
    (data.chapters||[]).map(ch => e("div",{key:ch.id,className:"card"},
      e("div",{className:"chapter",onClick:()=>{ setReader(ch); user && addHistory({id:uid(),user:user.mail,series:data.title,chapter:ch.title}); }}, ch.title),
      isAdmin && e("button",{onClick:()=>deleteChapter(ch.id)},"Usuń rozdział"),
      e("div",null,"Ocena: ",[1,2,3,4,5].map(v=>e("span",{key:v,style:{cursor:"pointer",color:v<=ch.rating?"#facc15":"#555"},onClick:()=>{ const updated={...data,chapters:data.chapters.map(c=>c.id===ch.id?{...c,rating:v}:c)}; setSeries(prev=>prev.map(s=>s.id===data.id?updated:s)); }},"★"))),
      e("div",null,ch.comments.map(c=>e("div",{key:c.text,className:"comment"},e("b",null,c.user+": "),c.text))),
      user && e("div",null,e("input",{placeholder:"Dodaj komentarz…",value:comment,onChange:e=>setComment(e.target.value)}),e("button",{onClick:()=>addCommentToChapter(ch)},"Dodaj"))
    ))
  );
}

// ------------------- Pozostałe komponenty -------------------
// LibraryComp, AddSeriesComp, ProfileComp, LoginComp, ReaderComp, RatingComp
// Ich struktura jest analogiczna i poprawiona podobnie jak powyżej

// RatingComp
function RatingComp({series}){
  const [rating, setRating] = React.useState(series.rating||0);
  function rate(v){ series.rating=v; save("series", load("series",[])); setRating(v); }
  return e("div", null, [1,2,3,4,5].map(v=>e("span",{key:v,style:{cursor:"pointer",color:v<=rating?"#facc15":"#555"},onClick:()=>rate(v)},"★")));
}

// ReaderComp
function ReaderComp({chapter,onClose}){
  return e("div",{className:"readerOverlay"},
    e("div",{className:"readerBar"},
      e("button",{onClick:onClose},"← Zamknij"),
      e("b",null,chapter.title)
    ),
    e("div",{className:"reader"},
      (chapter.images||[]).map((img,i)=>e("img",{key:i,src:img}))
    )
  );
}

// Render App
ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
