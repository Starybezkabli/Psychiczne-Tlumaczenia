<script>
const e=React.createElement;

const TAGS=[ "yaoi","yuri","hetero","romans","akcja","kryminalne","horror","krwawe","wampiry","inny świat","fantasy",
"wilkołaki","dziewczyny","chłopcy","przyjaciele z dzieciństwa","rodzina królewska","psychologiczne","kosmici",
"szkolne","policja","historyczne","slice of life","omegaverse","wojna","walki","morderstwa","lochy","potwory",
"magiczne","auta","wyścigi","drama","różnica wieku","demony","anioły","zagadki","ninja","zmiana ciał","komedia",
"duchy","dzieci","dla dorosłych","medyczne","sm/bdsm/sub-dom","gry wideo","muzyka","konkurencje","wróżki",
"fetysze","zemsta","klątwy"];

const ADMIN_MAIL="valerii000val@gmail.com";
const ADMIN_PASS="pika6969";

const load=(k,d)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Date.now()+Math.random();

function useRoute(){
const [r,setR]=React.useState(location.hash.slice(1)||"/");
React.useEffect(()=>{
const h=()=>setR(location.hash.slice(1)||"/");
addEventListener("hashchange",h);
return()=>removeEventListener("hashchange",h);
},[]);
return r;
}
const nav=p=>location.hash=p;

function App(){

const route=useRoute();

const [series,setSeries]=React.useState(load("series",[]));
const [accounts,setAccounts]=React.useState(load("accounts",{}));
const [user,setUser]=React.useState(load("user",null));
const [favorites,setFav]=React.useState(load("fav",[]));
const [history,setHist]=React.useState(load("hist",[]));
const [team,setTeam]=React.useState(load("team",[]));

React.useEffect(()=>save("series",series),[series]);
React.useEffect(()=>save("accounts",accounts),[accounts]);
React.useEffect(()=>save("user",user),[user]);
React.useEffect(()=>save("fav",favorites),[favorites]);
React.useEffect(()=>save("hist",history),[history]);
React.useEffect(()=>save("team",team),[team]);

// INIT ADMIN
React.useEffect(()=>{
setAccounts(prev=>{
const a={...prev};
if(!a[ADMIN_MAIL]){
a[ADMIN_MAIL]={
name:"StaryBezKabli",
password:ADMIN_PASS,
role:"admin",
avatar:null,
stats:{reads:0,chapters:0}
};
}
return a;
});
},[]);

const acc=user?accounts[user.mail]:null;
const isAdmin=acc?.role==="admin";
const isMod=isAdmin||acc?.role==="mod";

function addHistory(s,c){
if(!user)return;
setHist(h=>[{id:uid(),user:user.mail,series:s,chapter:c},...h.slice(0,100)]);
setAccounts(a=>{
const n={...a};
n[user.mail].stats.reads++;
return n;
});
}

const header=e("header",null,
e("b",{style:{cursor:"pointer"},onClick:()=>nav("/")},"Psychiczne tłumaczenia"),
e("button",{onClick:()=>nav("/library")},"Biblioteka"),
e("button",{onClick:()=>nav("/profile")},"Profil"),
isMod&&e("button",{onClick:()=>nav("/add")},"Dodaj tytuł"),
e("button",{onClick:()=>nav("/register")},"Rejestracja"),
isAdmin&&e("button",{onClick:()=>nav("/admin")},"Admin"),
user
?e("button",{onClick:()=>setUser(null)},"Wyloguj")
:e("button",{onClick:()=>nav("/login")},"Login")
);

let page;

if(route==="/") page=e(Home,{series,favorites,setFav,team,setTeam,isAdmin});
else if(route==="/add") page=e(AddSeries,{series,setSeries,isMod});
else if(route.startsWith("/series/")){
const id=route.split("/")[2];
page=e(Series,{
data:series.find(s=>s.id==id),
series,setSeries,
user,isMod,addHistory
});
}
else if(route.startsWith("/read/")){
const [_,__,sid,cid]=route.split("/");
const s=series.find(x=>x.id==sid);
const ch=s?.chapters.find(c=>c.id==cid);
page=e(Reader,{chapter:ch});
}
else if(route==="/library") page=e(Library,{series,favorites});
else if(route==="/profile") page=e(Profile,{user,accounts,setAccounts,history});
else if(route==="/admin") page=e(Admin,{accounts,setAccounts,isAdmin});
else if(route==="/login") page=e(Login,{accounts,setUser});
else if(route==="/register") page=e(Register,{accounts,setAccounts});
else page=e("div",null,"404");

return e("div",null,header,e("div",{style:{padding:12}},page));
}

function Home({series,favorites,setFav,team,setTeam,isAdmin}){

const [newMember,setNewMember]=React.useState("");

function addMember(){
if(!newMember)return;
setTeam(t=>[...t,newMember]);
setNewMember("");
}

return e("div",null,

e("h3",null,"Zespół"),
e("div",{className:"card"},
team.map((m,i)=>e("div",{key:i},m)),
isAdmin&&e("div",null,
e("input",{value:newMember,onChange:x=>setNewMember(x.target.value)}),
e("button",{onClick:addMember},"Dodaj członka")
)
),

e("h3",null,"Serie"),
e("div",{className:"grid"},
series.map(s=>e("div",{key:s.id,className:"card"},
s.cover&&e("img",{src:s.cover,className:"cover",onClick:()=>nav("/series/"+s.id)}),
e("b",{onClick:()=>nav("/series/"+s.id)},s.title),
e("button",{onClick:()=>setFav(
favorites.includes(s.id)
?favorites.filter(f=>f!==s.id)
:[...favorites,s.id])},
favorites.includes(s.id)?"★":"☆")
)))
);
}

function Library({series=[],favorites=[]}){
return e("div",{className:"grid"},
series.filter(s=>favorites.includes(s.id))
.map(s=>e("div",{key:s.id,className:"card"},
s.cover&&e("img",{src:s.cover,className:"cover",onClick:()=>nav("/series/"+s.id)}),
e("b",{onClick:()=>nav("/series/"+s.id)},s.title)
)));
}

function Reader({chapter}){
if(!chapter) return e("div",null,"Brak");
return e("div",{className:"readerOverlay"},
chapter.images.map((img,i)=>e("img",{key:i,src:img})),
e("button",{onClick:()=>nav("/")},"← Wyjdź")
);
}

function Profile({user,accounts,setAccounts,history}){
if(!user) return e("div",null,"Zaloguj się");

const acc=accounts[user.mail]||{};
const ranking=Object.entries(accounts)
.sort((a,b)=>(b[1].stats?.reads||0)-(a[1].stats?.reads||0));

return e("div",null,

e("div",{className:"card"},
e("h3",null,"Statystyki"),
"Reads: "+(acc.stats?.reads||0)
),

e("div",{className:"card"},
e("h3",null,"Historia"),
history.filter(h=>h.user===user.mail)
.map(h=>e("div",{key:h.id},h.series+" — "+h.chapter))
),

e("div",{className:"card"},
e("h3",null,"Ranking"),
ranking.map(([mail,a],i)=>
e("div",{key:mail},
(i+1)+". "+a.name+" — "+(a.stats?.reads||0)
))
)
);
}

function Login({accounts,setUser}){
const [mail,setMail]=React.useState("");
const [pass,setPass]=React.useState("");

function go(){
const acc=accounts[mail];
if(!acc||acc.password!==pass) return alert("Błąd");
setUser({mail,name:acc.name});
nav("/");
}

return e("div",{className:"card"},
e("input",{value:mail,onChange:x=>setMail(x.target.value)}),
e("input",{type:"password",value:pass,onChange:x=>setPass(x.target.value)}),
e("button",{onClick:go},"Login")
);
}

function Register({accounts,setAccounts}){
const [mail,setMail]=React.useState("");
const [name,setName]=React.useState("");
const [pass,setPass]=React.useState("");

function reg(){
if(accounts[mail]) return alert("Istnieje");
setAccounts(a=>({...a,
[mail]:{name,password:pass,role:"user",avatar:null,stats:{reads:0,chapters:0}}
}));
alert("OK");
nav("/login");
}

return e("div",{className:"card"},
e("input",{placeholder:"Nick",value:name,onChange:x=>setName(x.target.value)}),
e("input",{placeholder:"Email",value:mail,onChange:x=>setMail(x.target.value)}),
e("input",{type:"password",value:pass,onChange:x=>setPass(x.target.value)}),
e("button",{onClick:reg},"Rejestruj")
);
}

function Admin({accounts,setAccounts,isAdmin}){
if(!isAdmin) return e("div",null,"Brak dostępu");

function setRole(mail,role){
setAccounts(a=>{
const n={...a};
n[mail].role=role;
return n;
});
}

return e("div",{className:"card"},
Object.entries(accounts).map(([mail,a])=>
e("div",{key:mail},
mail,
e("select",{value:a.role||"user",
onChange:x=>setRole(mail,x.target.value)},
e("option",{value:"user"},"User"),
e("option",{value:"mod"},"Mod"),
e("option",{value:"admin"},"Admin")
)
))
);
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
